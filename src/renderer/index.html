<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title id="app-title">心至 - MindComplete</title>
    <link rel="stylesheet" href="assets/styles.css">
    <link rel="stylesheet" href="settings.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link id="highlight-theme" rel="stylesheet" href="assets/highlight.js/styles/github.min.css">
    <style>
        /* Markdown 样式 */
        .message-content {
            line-height: 1.5;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .message-content p {
            margin-bottom: 1em;
        }

        .message-content pre {
            background-color: var(--pre-bg);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            user-select: text;
            -webkit-user-select: text;
        }

        .message-content code {
            background-color: var(--code-bg);
            padding: 2px 4px;
            border-radius: 3px;
            user-select: text;
            -webkit-user-select: text;
            color: var(--text-color);
        }

        .message-content blockquote {
            border-left: 4px solid var(--border-color);
            padding-left: 10px;
            color: var(--secondary-text-color);
            margin-left: 0;
            user-select: text;
            -webkit-user-select: text;
        }

        .message-content ul,
        .message-content ol {
            padding-left: 2em;
        }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
        }

        .message-content th,
        .message-content td {
            border: 1px solid var(--border-color);
            padding: 8px;
        }

        .message-content th {
            background-color: var(--session-hover-bg);
        }

        /* 工具执行相关样式 */
        .message-content em {
            color: var(--secondary-text-color);
            font-style: italic;
        }

        .message-content strong {
            font-weight: bold;
            color: var(--text-color);
        }

        /* 代码块中的JSON格式化样式 */
        .hljs-attr {
            color: #0451a5;
        }

        .hljs-string {
            color: #a31515;
        }

        .hljs-number {
            color: #098658;
        }

        .hljs-literal {
            color: #0000ff;
        }

        /* 深色模式下的JSON高亮样式覆盖 */
        [data-theme="dark"] .hljs-attr {
            color: #9cdcfe;
        }

        [data-theme="dark"] .hljs-string {
            color: #ce9178;
        }

        [data-theme="dark"] .hljs-number {
            color: #b5cea8;
        }

        [data-theme="dark"] .hljs-literal {
            color: #569cd6;
        }

        /* 测试按钮样式 */
        .test-button {
            margin-left: 10px;
            padding: 5px 10px;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .test-button:hover {
            background-color: var(--button-hover);
        }

        /* 会话管理相关样式 - 已移到外部CSS文件 */
        /* 保留这里的注释以便查找 */

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }

        /* MCP服务选择器样式 */
        .mcp-dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
            /* Fill available width in container */
        }

        .mcp-dropdown-btn {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
            margin-right: 5px;
            width: 100%;
            /* Fill available width in container */
            height: 32px;
            /* Match settings-select height */
            box-sizing: border-box;
            /* Include padding and border in width/height */
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            /* Use flexbox for better alignment */
            align-items: center;
            /* Center content vertically */
            justify-content: space-between;
            /* Space between text and arrow */
            color: var(--text-color);
        }

        .mcp-dropdown-btn::after {
            content: "";
            width: 12px;
            height: 12px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="%23888" d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: center;
            margin-left: 5px;
        }

        [data-theme="dark"] .mcp-dropdown-btn::after {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="%23ccc" d="M7 10l5 5 5-5z"/></svg>');
        }

        .mcp-dropdown-btn.active {
            background-color: var(--input-bg);
            border-color: var(--button-bg);
        }

        .mcp-dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--dropdown-bg);
            width: 100%;
            /* Match button width exactly */
            box-shadow: 0px 8px 16px 0px var(--dropdown-shadow);
            z-index: 1000;
            max-height: calc(10 * 36px);
            /* Height for 10 items (each ~36px with padding) */
            overflow-y: auto;
            border-radius: 4px;
            bottom: 100%;
            /* Position above the button instead of below */
            left: 0;
        }

        .mcp-dropdown-content.show {
            display: block;
        }

        .mcp-server-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            background-color: var(--dropdown-bg);
        }

        .mcp-server-item:hover {
            background-color: var(--session-hover-bg);
        }

        .mcp-server-item.active {
            background-color: var(--session-hover-bg);
            border-left: 3px solid var(--button-bg);
        }

        .mcp-server-item.add-server-item {
            color: var(--text-color);
            font-weight: normal;
            border-bottom: 1px solid var(--border-color);
            padding: 5px 10px;
        }

        .mcp-server-item.add-server-item:hover {
            background-color: var(--session-hover-bg);
        }

        .mcp-server-item input {
            margin-right: 8px;
            cursor: pointer;
        }

        .mcp-empty-message {
            padding: 8px 12px;
            color: var(--secondary-text-color);
            font-style: italic;
            background-color: var(--dropdown-bg);
        }

        /* 错误信息样式 */
        .error-message {
            background-color: rgba(255, 0, 0, 0.1);
            border-left: 4px solid #ff6b6b;
            padding: 10px 15px;
            margin: 10px 0;
            color: var(--text-color);
            font-size: 14px;
            border-radius: 4px;
        }

        .open-settings-btn {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 5px 10px;
            margin-top: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: block;
        }

        .open-settings-btn:hover {
            background-color: var(--button-hover);
        }

        /* 添加配置按钮样式 */
        .add-config-btn {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 20px;
            font-size: 16px;
            margin-left: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .add-config-btn:hover {
            background-color: var(--button-hover);
        }

        /* 上下文菜单样式 */
        .context-menu {
            position: fixed;
            z-index: 1000;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            min-width: 120px;
            padding: 5px 0;
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background-color: #f0f0f0;
        }

        /* 系统菜单样式 */
        .system-menu {
            position: absolute;
            bottom: 60px;
            right: 10px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 150px;
        }

        .menu-item {
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--text-color);
        }

        .menu-item:hover {
            background-color: var(--session-hover-bg);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 会话管理侧边栏 -->
        <div class="sidebar" id="sidebar">
            <button id="sidebar-toggle" class="sidebar-toggle" title="折叠侧边栏">
                ◀
            </button>
            <div class="sidebar-collapse-icon" title="展开会话列表">
                🕒
            </div>

            <!-- 会话列表区域（上部区域） -->
            <div class="sidebar-upper">
                <div class="sidebar-header">
                    <h3 id="session-list-title">会话列表</h3>
                </div>
                <div id="sessions-container" class="sessions-container">
                    <!-- 会话列表将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 上下区域之间的拖动分隔条 -->
            <div id="sidebar-vertical-resizer" class="sidebar-vertical-resizer" title="拖动调整高度"></div>

            <!-- 设置和系统按钮（下部区域） -->
            <div class="sidebar-lower" id="sidebar-footer">
                <button id="settings-btn" class="settings-btn" title="设置">
                    <span class="settings-text" id="settings-text">设置</span>
                    <span class="settings-icon">⚙️</span>
                </button>

                <button id="system-btn" class="settings-btn" title="系统" style="position: relative;">
                    <span class="settings-text" id="system-text">系统</span>
                    <span class="settings-icon">🔧</span>
                </button>

                <!-- 系统菜单项，默认隐藏，显示在系统按钮下方 -->
                <div id="system-items-container" class="system-items-container" style="display: none;">
                    <div class="system-items">
                        <div class="system-item" id="about-item">
                            <span class="system-item-icon">ℹ️</span>
                            <span class="system-item-text">关于</span>
                        </div>
                        <div class="system-item" id="check-update-item">
                            <span class="system-item-icon">🔄</span>
                            <span class="system-item-text">检查更新</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 侧边栏拖动条 -->
        <div id="sidebar-resizer" class="sidebar-resizer" title="拖动调整宽度"></div>

        <!-- 主内容区 -->
        <div class="main-content">
            <div class="header">
                <h1 id="app-title-header">心至 - MindComplete</h1>
                <div class="header-right">
                    <button id="theme-toggle" class="theme-toggle" title="切换深色/浅色模式">
                        <span id="theme-toggle-icon" class="theme-toggle-icon">🌓</span>
                    </button>
                    <select id="language-select" class="language-select">
                        <option value="zh-CN">中文</option>
                        <option value="en-US">English</option>
                    </select>
                </div>
            </div>
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <div class="model-selector">
                        <select id="model-select" class="settings-select">
                        </select>
                        <select id="prompt-select" class="settings-select" title="选择提示词作为system message">
                            <!-- 提示词选项将通过JavaScript动态添加 -->
                        </select>

                        <!-- MCP服务下拉选择框 -->
                        <div class="mcp-dropdown">
                            <button id="mcp-dropdown-btn" class="mcp-dropdown-btn" type="button">MCP服务</button>
                            <div id="mcp-dropdown-content" class="mcp-dropdown-content">
                                <!-- MCP服务选项将通过JavaScript动态添加 -->
                            </div>
                        </div>

                        <button id="new-session-btn" class="test-button" title="创建新会话">新建会话</button>
                    </div>

                    <div class="input-group">
                        <input type="text" id="message-input" placeholder="输入消息，AI回复支持Markdown格式...">
                        <button id="send-button">发送</button>
                    </div>
                </div>
            </div>
            <div id="status" class="status">就绪</div>
        </div>
    </div>

    <!-- 自定义对话框 -->
    <div id="rename-dialog" class="custom-dialog" style="display: none;">
        <div class="dialog-content">
            <h3 id="rename-title">重命名会话</h3>
            <input type="text" id="new-name-input" class="dialog-input" placeholder="输入新的会话名称">
            <div class="dialog-buttons">
                <button id="rename-cancel-btn" class="dialog-btn">取消</button>
                <button id="rename-confirm-btn" class="dialog-btn dialog-confirm-btn">确定</button>
            </div>
        </div>
    </div>

    <script src="../locales/i18n.js"></script>
    <script src="renderer.js"></script>
    <script src="assets/highlight-init.js"></script>

    <script>
        // 在DOM加载完成后，初始化多语言支持
        document.addEventListener('DOMContentLoaded', () => {
            // 设置页面标题
            document.getElementById('app-title').textContent = i18n.t('app.title');
            document.getElementById('app-title-header').textContent = i18n.t('app.title');

            // 设置侧边栏文本
            document.getElementById('sidebar-toggle').title = i18n.t('sidebar.collapse');
            document.getElementById('session-list-title').textContent = i18n.t('sidebar.sessionList');
            document.getElementById('settings-text').textContent = i18n.t('sidebar.settings');
            document.getElementById('settings-btn').title = i18n.t('sidebar.settings');
            document.querySelector('.sidebar-collapse-icon').title = i18n.t('sidebar.expand');

            // 设置系统按钮文本
            document.getElementById('system-text').textContent = i18n.t('sidebar.system');
            document.getElementById('system-btn').title = i18n.t('sidebar.system');

            // 设置系统菜单项文本
            const aboutItem = document.getElementById('about-item').querySelector('.system-item-text');
            if (aboutItem) {
                aboutItem.textContent = i18n.t('sidebar.about');
            }

            const checkUpdateItem = document.getElementById('check-update-item').querySelector('.system-item-text');
            if (checkUpdateItem) {
                checkUpdateItem.textContent = i18n.t('sidebar.checkUpdate');
            }

            // 设置主界面文本
            document.getElementById('theme-toggle').title = i18n.t('header.toggleTheme');
            document.getElementById('prompt-select').title = i18n.t('modelSelector.promptTitle');
            document.getElementById('mcp-dropdown-btn').textContent = i18n.t('modelSelector.mcpServer');
            document.getElementById('new-session-btn').textContent = i18n.t('session.newSession');
            document.getElementById('new-session-btn').title = i18n.t('session.newSession');
            document.getElementById('message-input').placeholder = i18n.t('chat.placeholder');
            document.getElementById('send-button').textContent = i18n.t('chat.send');
            document.getElementById('status').textContent = i18n.t('ui.status.ready');

            // 设置重命名对话框文本
            document.getElementById('rename-title').textContent = i18n.t('session.renameTitle');
            document.getElementById('new-name-input').placeholder = i18n.t('session.newNamePlaceholder');
            document.getElementById('rename-cancel-btn').textContent = i18n.t('session.cancel');
            document.getElementById('rename-confirm-btn').textContent = i18n.t('session.confirm');

            // 延迟检查更新，确保界面已完全加载
            setTimeout(() => {
                // 应用启动时自动检查更新
                if (window.checkForUpdates) {
                    window.checkForUpdates();
                }
            }, 1000);
        });

        // 设置按钮点击事件
        document.getElementById('settings-btn').addEventListener('click', function (e) {
            e.stopPropagation();

            // 打开设置窗口
            window.openSettingsWindow();
        });

        // 系统按钮点击事件
        document.getElementById('system-btn').addEventListener('click', function (e) {
            e.stopPropagation();

            // 获取系统菜单容器
            const systemItemsContainer = document.getElementById('system-items-container');
            const sessionsContainer = document.getElementById('sessions-container');
            const sidebarLower = document.getElementById('sidebar-footer');

            // 如果侧边栏处于折叠状态，先展开侧边栏
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('collapsed')) {
                window.toggleSidebar(); // 调用toggleSidebar函数展开侧边栏

                // 在侧边栏展开后，加个短暂延迟再显示系统项区域，确保过渡效果顺畅
                setTimeout(() => {
                    systemItemsContainer.style.display = 'block';
                    // 添加菜单打开标记类
                    sidebarLower.classList.add('menu-open');
                    sessionsContainer.classList.add('menu-open');
                }, 300); // 等待侧边栏展开动画完成
            } else {
                // 在侧边栏已展开状态下，直接切换系统项区域显示
                systemItemsContainer.style.display = systemItemsContainer.style.display === 'none' ? 'block' : 'none';

                // 在显示系统菜单时，添加一个标记类，使其位置合适
                if (systemItemsContainer.style.display === 'block') {
                    sidebarLower.classList.add('menu-open');
                    sessionsContainer.classList.add('menu-open');
                } else {
                    // 当隐藏菜单时，先移除菜单打开标记类，在系统项目完全隐藏后再重置位置
                    setTimeout(() => {
                        sidebarLower.classList.remove('menu-open');
                        sessionsContainer.classList.remove('menu-open');
                    }, 50); // 短暂延迟，确保系统项目先隐藏
                }
            }
        });

        // 关于按钮点击事件
        document.getElementById('about-item').addEventListener('click', function () {
            window.openAboutWindow();
        });

        // 检查更新按钮点击事件
        document.getElementById('check-update-item').addEventListener('click', function () {
            // 调用主进程中的检查更新函数
            window.checkForUpdates();
        });

        // 点击其他地方关闭系统项区域
        document.addEventListener('click', function (e) {
            const systemItemsContainer = document.getElementById('system-items-container');
            // 如果点击的不是系统按钮和系统项区域内的元素，并且系统项区域是可见的
            if (!e.target.closest('#system-btn') && !e.target.closest('#system-items-container') &&
                systemItemsContainer.style.display === 'block') {
                systemItemsContainer.style.display = 'none';
                // 移除菜单打开标记类
                setTimeout(() => {
                    const sidebarLower = document.getElementById('sidebar-footer');
                    sidebarLower.classList.remove('menu-open');
                    document.getElementById('sessions-container').classList.remove('menu-open');
                }, 50);
            }
        });
    </script>
</body>

</html>