<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title id="app-title">å¿ƒè‡³ - MindComplete</title>
    <link rel="stylesheet" href="assets/styles.css">
    <link rel="stylesheet" href="settings.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link id="highlight-theme" rel="stylesheet" href="assets/highlight.js/styles/github.min.css">
    <style>
        /* Markdown æ ·å¼ */
        .message-content {
            line-height: 1.5;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .message-content p {
            margin-bottom: 1em;
        }

        .message-content pre {
            background-color: var(--pre-bg);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            user-select: text;
            -webkit-user-select: text;
        }

        .message-content code {
            background-color: var(--code-bg);
            padding: 2px 4px;
            border-radius: 3px;
            user-select: text;
            -webkit-user-select: text;
            color: var(--text-color);
        }

        .message-content blockquote {
            border-left: 4px solid var(--border-color);
            padding-left: 10px;
            color: var(--secondary-text-color);
            margin-left: 0;
            user-select: text;
            -webkit-user-select: text;
        }

        .message-content ul,
        .message-content ol {
            padding-left: 2em;
        }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
        }

        .message-content th,
        .message-content td {
            border: 1px solid var(--border-color);
            padding: 8px;
        }

        .message-content th {
            background-color: var(--session-hover-bg);
        }

        /* å·¥å…·æ‰§è¡Œç›¸å…³æ ·å¼ */
        .message-content em {
            color: var(--secondary-text-color);
            font-style: italic;
        }

        .message-content strong {
            font-weight: bold;
            color: var(--text-color);
        }

        /* ä»£ç å—ä¸­çš„JSONæ ¼å¼åŒ–æ ·å¼ */
        .hljs-attr {
            color: #0451a5;
        }

        .hljs-string {
            color: #a31515;
        }

        .hljs-number {
            color: #098658;
        }

        .hljs-literal {
            color: #0000ff;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹çš„JSONé«˜äº®æ ·å¼è¦†ç›– */
        [data-theme="dark"] .hljs-attr {
            color: #9cdcfe;
        }

        [data-theme="dark"] .hljs-string {
            color: #ce9178;
        }

        [data-theme="dark"] .hljs-number {
            color: #b5cea8;
        }

        [data-theme="dark"] .hljs-literal {
            color: #569cd6;
        }

        /* æµ‹è¯•æŒ‰é’®æ ·å¼ */
        .test-button {
            margin-left: 10px;
            padding: 5px 10px;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .test-button:hover {
            background-color: var(--button-hover);
        }

        /* ä¼šè¯ç®¡ç†ç›¸å…³æ ·å¼ - å·²ç§»åˆ°å¤–éƒ¨CSSæ–‡ä»¶ */
        /* ä¿ç•™è¿™é‡Œçš„æ³¨é‡Šä»¥ä¾¿æŸ¥æ‰¾ */

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }

        /* MCPæœåŠ¡é€‰æ‹©å™¨æ ·å¼ */
        .mcp-dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
            /* Fill available width in container */
        }

        .mcp-dropdown-btn {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
            margin-right: 5px;
            width: 100%;
            /* Fill available width in container */
            height: 32px;
            /* Match settings-select height */
            box-sizing: border-box;
            /* Include padding and border in width/height */
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            /* Use flexbox for better alignment */
            align-items: center;
            /* Center content vertically */
            justify-content: space-between;
            /* Space between text and arrow */
            color: var(--text-color);
        }

        .mcp-dropdown-btn::after {
            content: "";
            width: 12px;
            height: 12px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="%23888" d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: center;
            margin-left: 5px;
        }

        [data-theme="dark"] .mcp-dropdown-btn::after {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="%23ccc" d="M7 10l5 5 5-5z"/></svg>');
        }

        .mcp-dropdown-btn.active {
            background-color: var(--input-bg);
            border-color: var(--button-bg);
        }

        .mcp-dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--dropdown-bg);
            width: 100%;
            /* Match button width exactly */
            box-shadow: 0px 8px 16px 0px var(--dropdown-shadow);
            z-index: 1000;
            max-height: calc(10 * 36px);
            /* Height for 10 items (each ~36px with padding) */
            overflow-y: auto;
            border-radius: 4px;
            bottom: 100%;
            /* Position above the button instead of below */
            left: 0;
        }

        .mcp-dropdown-content.show {
            display: block;
        }

        .mcp-server-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            background-color: var(--dropdown-bg);
        }

        .mcp-server-item:hover {
            background-color: var(--session-hover-bg);
        }

        .mcp-server-item.active {
            background-color: var(--session-hover-bg);
            border-left: 3px solid var(--button-bg);
        }

        .mcp-server-item.add-server-item {
            color: var(--text-color);
            font-weight: normal;
            border-bottom: 1px solid var(--border-color);
            padding: 5px 10px;
        }

        .mcp-server-item.add-server-item:hover {
            background-color: var(--session-hover-bg);
        }

        .mcp-server-item input {
            margin-right: 8px;
            cursor: pointer;
        }

        .mcp-empty-message {
            padding: 8px 12px;
            color: var(--secondary-text-color);
            font-style: italic;
            background-color: var(--dropdown-bg);
        }

        /* é”™è¯¯ä¿¡æ¯æ ·å¼ */
        .error-message {
            background-color: rgba(255, 0, 0, 0.1);
            border-left: 4px solid #ff6b6b;
            padding: 10px 15px;
            margin: 10px 0;
            color: var(--text-color);
            font-size: 14px;
            border-radius: 4px;
        }

        .open-settings-btn {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 5px 10px;
            margin-top: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: block;
        }

        .open-settings-btn:hover {
            background-color: var(--button-hover);
        }

        /* æ·»åŠ é…ç½®æŒ‰é’®æ ·å¼ */
        .add-config-btn {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 20px;
            font-size: 16px;
            margin-left: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .add-config-btn:hover {
            background-color: var(--button-hover);
        }

        /* ä¸Šä¸‹æ–‡èœå•æ ·å¼ */
        .context-menu {
            position: fixed;
            z-index: 1000;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            min-width: 120px;
            padding: 5px 0;
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background-color: #f0f0f0;
        }

        /* ç³»ç»Ÿèœå•æ ·å¼ */
        .system-menu {
            position: absolute;
            bottom: 60px;
            right: 10px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 150px;
        }

        .menu-item {
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--text-color);
        }

        .menu-item:hover {
            background-color: var(--session-hover-bg);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ä¼šè¯ç®¡ç†ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <button id="sidebar-toggle" class="sidebar-toggle" title="æŠ˜å ä¾§è¾¹æ ">
                â—€
            </button>
            <div class="sidebar-collapse-icon" title="å±•å¼€ä¼šè¯åˆ—è¡¨">
                ğŸ•’
            </div>

            <!-- ä¼šè¯åˆ—è¡¨åŒºåŸŸï¼ˆä¸Šéƒ¨åŒºåŸŸï¼‰ -->
            <div class="sidebar-upper">
                <div class="sidebar-header">
                    <h3 id="session-list-title">ä¼šè¯åˆ—è¡¨</h3>
                </div>
                <div id="sessions-container" class="sessions-container">
                    <!-- ä¼šè¯åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ä¸Šä¸‹åŒºåŸŸä¹‹é—´çš„æ‹–åŠ¨åˆ†éš”æ¡ -->
            <div id="sidebar-vertical-resizer" class="sidebar-vertical-resizer" title="æ‹–åŠ¨è°ƒæ•´é«˜åº¦"></div>

            <!-- è®¾ç½®å’Œç³»ç»ŸæŒ‰é’®ï¼ˆä¸‹éƒ¨åŒºåŸŸï¼‰ -->
            <div class="sidebar-lower" id="sidebar-footer">
                <button id="settings-btn" class="settings-btn" title="è®¾ç½®">
                    <span class="settings-text" id="settings-text">è®¾ç½®</span>
                    <span class="settings-icon">âš™ï¸</span>
                </button>

                <button id="system-btn" class="settings-btn" title="ç³»ç»Ÿ" style="position: relative;">
                    <span class="settings-text" id="system-text">ç³»ç»Ÿ</span>
                    <span class="settings-icon">ğŸ”§</span>
                </button>

                <!-- ç³»ç»Ÿèœå•é¡¹ï¼Œé»˜è®¤éšè—ï¼Œæ˜¾ç¤ºåœ¨ç³»ç»ŸæŒ‰é’®ä¸‹æ–¹ -->
                <div id="system-items-container" class="system-items-container" style="display: none;">
                    <div class="system-items">
                        <div class="system-item" id="about-item">
                            <span class="system-item-icon">â„¹ï¸</span>
                            <span class="system-item-text">å…³äº</span>
                        </div>
                        <div class="system-item" id="check-update-item">
                            <span class="system-item-icon">ğŸ”„</span>
                            <span class="system-item-text">æ£€æŸ¥æ›´æ–°</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¾§è¾¹æ æ‹–åŠ¨æ¡ -->
        <div id="sidebar-resizer" class="sidebar-resizer" title="æ‹–åŠ¨è°ƒæ•´å®½åº¦"></div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="header">
                <h1 id="app-title-header">å¿ƒè‡³ - MindComplete</h1>
                <div class="header-right">
                    <button id="theme-toggle" class="theme-toggle" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼">
                        <span id="theme-toggle-icon" class="theme-toggle-icon">ğŸŒ“</span>
                    </button>
                    <select id="language-select" class="language-select">
                        <option value="zh-CN">ä¸­æ–‡</option>
                        <option value="en-US">English</option>
                    </select>
                </div>
            </div>
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <div class="model-selector">
                        <select id="model-select" class="settings-select">
                        </select>
                        <select id="prompt-select" class="settings-select" title="é€‰æ‹©æç¤ºè¯ä½œä¸ºsystem message">
                            <!-- æç¤ºè¯é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                        </select>

                        <!-- MCPæœåŠ¡ä¸‹æ‹‰é€‰æ‹©æ¡† -->
                        <div class="mcp-dropdown">
                            <button id="mcp-dropdown-btn" class="mcp-dropdown-btn" type="button">MCPæœåŠ¡</button>
                            <div id="mcp-dropdown-content" class="mcp-dropdown-content">
                                <!-- MCPæœåŠ¡é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                            </div>
                        </div>

                        <button id="new-session-btn" class="test-button" title="åˆ›å»ºæ–°ä¼šè¯">æ–°å»ºä¼šè¯</button>
                    </div>

                    <div class="input-group">
                        <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒAIå›å¤æ”¯æŒMarkdownæ ¼å¼...">
                        <button id="send-button">å‘é€</button>
                    </div>
                </div>
            </div>
            <div id="status" class="status">å°±ç»ª</div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰å¯¹è¯æ¡† -->
    <div id="rename-dialog" class="custom-dialog" style="display: none;">
        <div class="dialog-content">
            <h3 id="rename-title">é‡å‘½åä¼šè¯</h3>
            <input type="text" id="new-name-input" class="dialog-input" placeholder="è¾“å…¥æ–°çš„ä¼šè¯åç§°">
            <div class="dialog-buttons">
                <button id="rename-cancel-btn" class="dialog-btn">å–æ¶ˆ</button>
                <button id="rename-confirm-btn" class="dialog-btn dialog-confirm-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script src="../locales/i18n.js"></script>
    <script src="renderer.js"></script>
    <script src="assets/highlight-init.js"></script>

    <script>
        // åœ¨DOMåŠ è½½å®Œæˆåï¼Œåˆå§‹åŒ–å¤šè¯­è¨€æ”¯æŒ
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®é¡µé¢æ ‡é¢˜
            document.getElementById('app-title').textContent = i18n.t('app.title');
            document.getElementById('app-title-header').textContent = i18n.t('app.title');

            // è®¾ç½®ä¾§è¾¹æ æ–‡æœ¬
            document.getElementById('sidebar-toggle').title = i18n.t('sidebar.collapse');
            document.getElementById('session-list-title').textContent = i18n.t('sidebar.sessionList');
            document.getElementById('settings-text').textContent = i18n.t('sidebar.settings');
            document.getElementById('settings-btn').title = i18n.t('sidebar.settings');
            document.querySelector('.sidebar-collapse-icon').title = i18n.t('sidebar.expand');

            // è®¾ç½®ç³»ç»ŸæŒ‰é’®æ–‡æœ¬
            document.getElementById('system-text').textContent = i18n.t('sidebar.system');
            document.getElementById('system-btn').title = i18n.t('sidebar.system');

            // è®¾ç½®ç³»ç»Ÿèœå•é¡¹æ–‡æœ¬
            const aboutItem = document.getElementById('about-item').querySelector('.system-item-text');
            if (aboutItem) {
                aboutItem.textContent = i18n.t('sidebar.about');
            }

            const checkUpdateItem = document.getElementById('check-update-item').querySelector('.system-item-text');
            if (checkUpdateItem) {
                checkUpdateItem.textContent = i18n.t('sidebar.checkUpdate');
            }

            // è®¾ç½®ä¸»ç•Œé¢æ–‡æœ¬
            document.getElementById('theme-toggle').title = i18n.t('header.toggleTheme');
            document.getElementById('prompt-select').title = i18n.t('modelSelector.promptTitle');
            document.getElementById('mcp-dropdown-btn').textContent = i18n.t('modelSelector.mcpServer');
            document.getElementById('new-session-btn').textContent = i18n.t('session.newSession');
            document.getElementById('new-session-btn').title = i18n.t('session.newSession');
            document.getElementById('message-input').placeholder = i18n.t('chat.placeholder');
            document.getElementById('send-button').textContent = i18n.t('chat.send');
            document.getElementById('status').textContent = i18n.t('ui.status.ready');

            // è®¾ç½®é‡å‘½åå¯¹è¯æ¡†æ–‡æœ¬
            document.getElementById('rename-title').textContent = i18n.t('session.renameTitle');
            document.getElementById('new-name-input').placeholder = i18n.t('session.newNamePlaceholder');
            document.getElementById('rename-cancel-btn').textContent = i18n.t('session.cancel');
            document.getElementById('rename-confirm-btn').textContent = i18n.t('session.confirm');

            // å»¶è¿Ÿæ£€æŸ¥æ›´æ–°ï¼Œç¡®ä¿ç•Œé¢å·²å®Œå…¨åŠ è½½
            setTimeout(() => {
                // åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
                if (window.checkForUpdates) {
                    window.checkForUpdates();
                }
            }, 1000);
        });

        // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('settings-btn').addEventListener('click', function (e) {
            e.stopPropagation();

            // æ‰“å¼€è®¾ç½®çª—å£
            window.openSettingsWindow();
        });

        // ç³»ç»ŸæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('system-btn').addEventListener('click', function (e) {
            e.stopPropagation();

            // è·å–ç³»ç»Ÿèœå•å®¹å™¨
            const systemItemsContainer = document.getElementById('system-items-container');
            const sessionsContainer = document.getElementById('sessions-container');
            const sidebarLower = document.getElementById('sidebar-footer');

            // å¦‚æœä¾§è¾¹æ å¤„äºæŠ˜å çŠ¶æ€ï¼Œå…ˆå±•å¼€ä¾§è¾¹æ 
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('collapsed')) {
                window.toggleSidebar(); // è°ƒç”¨toggleSidebarå‡½æ•°å±•å¼€ä¾§è¾¹æ 

                // åœ¨ä¾§è¾¹æ å±•å¼€åï¼ŒåŠ ä¸ªçŸ­æš‚å»¶è¿Ÿå†æ˜¾ç¤ºç³»ç»Ÿé¡¹åŒºåŸŸï¼Œç¡®ä¿è¿‡æ¸¡æ•ˆæœé¡ºç•…
                setTimeout(() => {
                    systemItemsContainer.style.display = 'block';
                    // æ·»åŠ èœå•æ‰“å¼€æ ‡è®°ç±»
                    sidebarLower.classList.add('menu-open');
                    sessionsContainer.classList.add('menu-open');
                }, 300); // ç­‰å¾…ä¾§è¾¹æ å±•å¼€åŠ¨ç”»å®Œæˆ
            } else {
                // åœ¨ä¾§è¾¹æ å·²å±•å¼€çŠ¶æ€ä¸‹ï¼Œç›´æ¥åˆ‡æ¢ç³»ç»Ÿé¡¹åŒºåŸŸæ˜¾ç¤º
                systemItemsContainer.style.display = systemItemsContainer.style.display === 'none' ? 'block' : 'none';

                // åœ¨æ˜¾ç¤ºç³»ç»Ÿèœå•æ—¶ï¼Œæ·»åŠ ä¸€ä¸ªæ ‡è®°ç±»ï¼Œä½¿å…¶ä½ç½®åˆé€‚
                if (systemItemsContainer.style.display === 'block') {
                    sidebarLower.classList.add('menu-open');
                    sessionsContainer.classList.add('menu-open');
                } else {
                    // å½“éšè—èœå•æ—¶ï¼Œå…ˆç§»é™¤èœå•æ‰“å¼€æ ‡è®°ç±»ï¼Œåœ¨ç³»ç»Ÿé¡¹ç›®å®Œå…¨éšè—åå†é‡ç½®ä½ç½®
                    setTimeout(() => {
                        sidebarLower.classList.remove('menu-open');
                        sessionsContainer.classList.remove('menu-open');
                    }, 50); // çŸ­æš‚å»¶è¿Ÿï¼Œç¡®ä¿ç³»ç»Ÿé¡¹ç›®å…ˆéšè—
                }
            }
        });

        // å…³äºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('about-item').addEventListener('click', function () {
            window.openAboutWindow();
        });

        // æ£€æŸ¥æ›´æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('check-update-item').addEventListener('click', function () {
            // è°ƒç”¨ä¸»è¿›ç¨‹ä¸­çš„æ£€æŸ¥æ›´æ–°å‡½æ•°
            window.checkForUpdates();
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ç³»ç»Ÿé¡¹åŒºåŸŸ
        document.addEventListener('click', function (e) {
            const systemItemsContainer = document.getElementById('system-items-container');
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ç³»ç»ŸæŒ‰é’®å’Œç³»ç»Ÿé¡¹åŒºåŸŸå†…çš„å…ƒç´ ï¼Œå¹¶ä¸”ç³»ç»Ÿé¡¹åŒºåŸŸæ˜¯å¯è§çš„
            if (!e.target.closest('#system-btn') && !e.target.closest('#system-items-container') &&
                systemItemsContainer.style.display === 'block') {
                systemItemsContainer.style.display = 'none';
                // ç§»é™¤èœå•æ‰“å¼€æ ‡è®°ç±»
                setTimeout(() => {
                    const sidebarLower = document.getElementById('sidebar-footer');
                    sidebarLower.classList.remove('menu-open');
                    document.getElementById('sessions-container').classList.remove('menu-open');
                }, 50);
            }
        });
    </script>
</body>

</html>